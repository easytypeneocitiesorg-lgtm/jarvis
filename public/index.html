<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jarvis</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #111; color: #eee; }
    h1 { color: #0ff; }
    #status { font-weight: bold; margin-bottom: 10px; }
    #user, #ai { border: 1px solid #333; padding: 10px; margin: 5px 0; border-radius: 5px; }
    #user { background: #222; color: #0f0; }
    #ai { background: #222; color: #0ff; }
  </style>
</head>
<body>
  <h1>Jarvis Online</h1>
  <p id="status">ğŸ™ï¸ Listeningâ€¦</p>

  <div id="user">You said: </div>
  <div id="ai">Jarvis says: </div>

  <script>
    let listeningForCommand = false;
    let busy = false;
    let lastTrigger = 0;
    const COOLDOWN_MS = 5000;

    const statusEl = document.getElementById("status");
    const userEl = document.getElementById("user");
    const aiEl = document.getElementById("ai");

    function setStatus(text) { statusEl.textContent = text; }

    function beep() {
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      osc.type = "sine";
      osc.frequency.value = 880;
      osc.connect(ctx.destination);
      osc.start();
      setTimeout(() => osc.stop(), 120);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      setStatus("âŒ Speech recognition not supported");
      throw new Error("SpeechRecognition unsupported");
    }

    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true; // show partial results
    recognition.lang = "en-US";

    recognition.onresult = async (event) => {
      const transcript =
        Array.from(event.results)
          .map(r => r[0].transcript)
          .join('')
          .trim();

      userEl.textContent = "You said: " + transcript;

      // Wake word detection
      if (transcript.toLowerCase().includes("hey jarvis")) {
        beep();
        setStatus("ğŸŸ¢ Wake word detected!");
        listeningForCommand = true;
        speak("Yes?");
        return;
      }

      if (!listeningForCommand || busy) return;

      const now = Date.now();
      if (now - lastTrigger < COOLDOWN_MS) return;

      busy = true;
      listeningForCommand = false;
      lastTrigger = now;
      setStatus("â³ Thinkingâ€¦");

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: transcript })
        });
        const data = await res.json();
        aiEl.textContent = "Jarvis says: " + data.reply;
        setStatus("ğŸ—£ï¸ Speakingâ€¦");
        speak(data.reply);
      } catch (err) {
        console.error(err);
        setStatus("âŒ Jarvis error");
      } finally {
        busy = false;
      }
    };

    recognition.onerror = (e) => {
      console.error(e);
      setStatus("âš ï¸ Mic error, restartingâ€¦");
    };

    recognition.onend = () => {
      setStatus("ğŸ™ï¸ Listeningâ€¦");
      recognition.start();
    };

    recognition.start();

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 0.9;
      utter.pitch = 0.8;
      utter.onend = () => setStatus("ğŸ™ï¸ Listeningâ€¦");
      speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
